# --- Global Nginx Configuration ---

# Define the user that will run the nginx worker processes.
# 'nginx' is the default non-root user in the official alpine image.
user  nginx;

# 'auto' automatically detects the number of available CPU cores
# to optimize the number of worker processes.
worker_processes auto;

# Path for global error logs. 'warn' is a good level for production.
error_log  /var/log/nginx/error.log warn;

# File to store the master process ID.
pid        /var/run/nginx.pid;


# --- Events Module ---
# Configuration for network-related events.
events {
    # Max number of simultaneous connections a worker process can open.
    worker_connections 1024;
}


# --- HTTP Module ---
# Main block for all HTTP/HTTPS server configurations.
http {
    # --- Core HTTP Settings ---

    # Include the file that maps file extensions to MIME types (e.g., .css -> text/css).
    include       /etc/nginx/mime.types;
    # Default MIME type to use if the extension is unknown.
    default_type  application/octet-stream;

    # 'sendfile on' allows nginx to use the kernel's 'sendfile' syscall
    # to send files directly, which is much faster than reading/writing.
    sendfile        on;

    # 'tcp_nopush on' optimizes packet sending by waiting for the packet to be full.
    # It's often used with 'sendfile'.
    tcp_nopush      on;

    # 'tcp_nodelay on' forces nginx to send data immediately (disables Nagle's algorithm).
    # Good for responsive applications.
    tcp_nodelay     on;

    # Timeout for keep-alive connections with a client.
    keepalive_timeout  65;

    # --- Logging ---

    # Define a custom log format 'main_ext' that includes cookies.
    # This is useful for debugging API proxy requests.
    log_format main_ext '$remote_addr - $remote_user [$time_local] "$request" '
                       '$status $body_bytes_sent "$http_referer" '
                       '"$http_user_agent" Cookie:"$http_cookie"';

    # Set the global access log to use our custom format.
    access_log /var/log/nginx/access.log main_ext;

    # --- Global SSL/TLS Settings ---

    # Optimize SSL performance by caching session parameters (50MB cache).
    ssl_session_cache shared:SSL:50m;
    # Set timeout for cached sessions to 1 day.
    ssl_session_timeout 1d;
    # Disable session tickets, which can have security implications.
    ssl_session_tickets off;

    # Specify modern, secure TLS protocols. (TLSv1.0 and 1.1 are deprecated).
    ssl_protocols TLSv1.2 TLSv1.3;
    # 'off' lets the client choose the cipher, which is generally preferred
    # for broader compatibility, as modern clients will pick secure ciphers.
    ssl_prefer_server_ciphers off;


    # --- Server Block 1: HTTP-to-HTTPS Redirect ---
    # This server catches all traffic on port 80.
    server {
        listen 80;
        listen [::]:80; # Listen on IPv6 as well

        # This block will respond to requests for 'antares.local' or 'localhost'.
        server_name antares.local localhost;

        # Send a 301 (Permanent Redirect) to the client,
        # instructing them to go to the 'https' version of the same host and URL.
        return 301 https://antares.local$request_uri;
    }


    # --- Server Block 2: Main HTTPS Application Server ---
    # This server handles all secure traffic.
    server {
        listen 443 ssl;
        listen [::]:443 ssl; # Listen on IPv6

        # Enable HTTP/2 for better performance (multiplexing, header compression).
        http2 on;

        # The hostname this server block responds to.
        server_name antares.local;

        # Paths to the SSL certificate and private key.
        # These are mounted via volumes in docker-compose.yml.
        ssl_certificate     /etc/nginx/certs/cert.crt;
        ssl_certificate_key /etc/nginx/certs/cert.key;

        # --- Security Headers ---
        # Add headers to all responses to improve application security.

        # HTTP Strict Transport Security (HSTS): Tells browsers to *only*
        # communicate with this site over HTTPS for the next year (max-age).
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

        # Prevents browser from MIME-sniffing the content-type.
        add_header X-Content-Type-Options "nosniff" always;

        # Prevents the site from being loaded in an <iframe> (clickjacking defense).
        add_header X-Frame-Options "SAMEORIGIN" always;

        # Controls how much referrer information is sent with requests.
        add_header Referrer-Policy "no-referrer-when-downgrade" always;

        # Deprecated XSS header. Set to "0" to disable it, as we rely on the
        # more modern Content-Security-Policy header.
        add_header X-XSS-Protection "0" always;

        # Content Security Policy (CSP): A strong defense against XSS.
        add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self'; connect-src 'self';" always;

        # --- Static File Serving (Angular App) ---

        # Set the root directory for static files (where index.html lives).
        # This path matches the 'COPY' destination in the Dockerfile.
        root /usr/share/nginx/html;

        # Default file to serve if a directory is requested.
        index index.html;

        # --- API Reverse Proxy ---
        # This block catches all requests starting with /api/
        # and forwards them to the backend 'antares-api' service.
        location /api/ {
            # 'http://antares-api:8080' uses the Docker Compose service name.
            # Nginx will resolve 'antares-api' to the correct container IP.
            proxy_pass http://antares-api:8080;

            proxy_http_version 1.1;

            # --- Proxy Headers ---
            # Pass essential headers to the backend so it knows about the original client.

            # Pass the original 'Host' header (e.g., 'antares.local').
            proxy_set_header Host $host;
            # Pass the client's real IP address.
            proxy_set_header X-Real-IP $remote_addr;
            # Pass the chain of proxy IPs.
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # Pass the original protocol (http or https).
            proxy_set_header X-Forwarded-Proto $scheme;

            # Forward authentication (e.g., Bearer tokens) and cookies.
            proxy_set_header Authorization $http_authorization;
            proxy_set_header Cookie $http_cookie;
            proxy_pass_request_headers on;

            # Connection header settings for keep-alive connections to the upstream.
            proxy_set_header Connection "";
            proxy_buffers 16 4k;
            proxy_read_timeout 90;

            # Ensures proxied cookies have the correct path.
            proxy_cookie_path / "/";
        }

        # --- SPA Fallback ---
        # This block handles all other requests (e.g., /dashboard, /login).
        location / {
            # 'try_files' is the key for Single Page Applications (SPAs).
            # 1. It tries to find a file matching the exact $uri.
            # 2. If not found, it tries to find a directory $uri/.
            # 3. If not found, it serves /index.html.
            # This lets Angular's router handle the URL instead of nginx.
            try_files $uri $uri/ /index.html;
        }
    }
}
